
# Users - Roles & Permission
### Models/UserPermissionModel.js - This model is used when permission is assign to users

```js
const UserPermissionModel = new Mongoose.Schema({

    user_id:{
        type:mongoose.Schema.Types.ObjectId,
        required: true,
        ref:'User'
    },
    permissions:[{
        permission_name: String,
        permission_value: [number]  // 0-create, 1-read, 2-edit, 3-delete
    }]
})

module.exports = mongoose.model('UserPermission', UserPermissionModel);

sample:
{
    "_id": "60d21b4667d0d8992e610c85", // ObjectId generated by MongoDB
    "user_id": "60d21b2067d0d8992e610c84", // ObjectId referencing a User document
    "permissions": [
        {
            "permission_name": "post",
            "permission_value": [0, 1, 2] // create, read, edit permissions
        },
        {
            "permission_name": "comment",
            "permission_value": [1, 3] // read, delete permissions
        }
    ]
}

``` 
### Models/PermissionModel.js - This model is for Admin to create Permission.

```js
const PermissionModel = new Mongoose.Schema({

    permission_name:{
        type:String,
        required: true,        
    },
    is_Default:{
        type:Number,
        default:0  // 0-> Not-Default, 1-> Default
    }
});

module.exports = mongoose.model('Permission', UserPermissionModel);

sample:
[
    {
        "_id": "60d21b4667d0d8992e610c86",
        "permission_name": "read",
        "is_Default": 1
    },
    {
        "_id": "60d21b4667d0d8992e610c87",
        "permission_name": "write",
        "is_Default": 0
    },
    {
        "_id": "60d21b4667d0d8992e610c88",
        "permission_name": "execute",
        "is_Default": 0
    }
]
```

### Routes/adminRoutes.js
```js
const { permissionAddValidator } = require('../helper/adminValidator');

// path: http://localhost:3000/api/admin/add-permission
routes.post('add-permission', permissionAddValidator, )
```

### Contoller/admin/adminController.js
```js
const addPermission = async(req, res) => {
    
    try{
            //1. do validation
            //2. recv req
            const { permission_name } = req.body;

            //3. find in database, if same permission is not exists.
            //4. create obj 
            let obj = {
                permission_name
            }
            //5.if want to set default value
            if(req.body.default){
                obj.is_default= parseInt(req.body.default)
            }

            //6.save to db
            const permission = new Permission(obj);
            const newPermission = await permission.save();
        
        return res.status(201).json({
            success:true,
            message:'Permission added Successfully',
            data: newPermission
        })

    }catch(){

    }    
}
```
### Postman

```js
POST | http://localhost:3000/api/admin/add-permission
Body(raw): {
    permission_name:'Comment'
    default:1
}
```

### Controller/admin/PermissionController.js - Create Read, Delete, Update Permission for admin
```js

//Create
const addPermission = () => {}

//Read
const getPermissons = () => {}

//Delete
const deletePermission = () => {}

//Update
const updatePermission = (req, res) => {
    
    // 1. validateRequest - do validation express-validator or JOI (optinal) {_id - requied, permission_name - required }
    // if empty return error

    // 2. isExists - is Id(Permission) exist
    const isExists = await Permission.findOne({
        _id:{
            $ne: _id
        },
        permission_name:{
            $regex: permisson_name,
            $options: i
        }
    });

    // 3. isNameAssigned
    const isNameAssigned = await Permission.findOne({
        _id:{
            $ne: id
        },
        permission_name:{
            $regex: permisson_name,
            $options: 'i'
        }
    });

    // 4. update Permission - findByIdAndUpdate    
}

POSTMAN
POST | http://............./admin/update-permission
Body(raw):{
    'id':'67333a82dbeec2eefa34d2eb',
    'permission_name':'Comment'
}
```

### Only admin can access Admin-Permission
#### Route/adminRoute.js

```js
route.post('/add-permission', auth, onlyAdminAccess, permissionValidator, permissonController.addPermission);

route.get('/get-permission', auth, onlyAdminAccess, permissionValidator, permissonController.getPermission);

route.post('/update-permission', auth, onlyAdminAccess, permissionValidator, permissonController.updatePermission);

route.post('/delete-permission', auth, onlyAdminAccess, permissionValidator, permissonController.deletePermission);
```
#### Add Middleware - Middleware/adminMiddleware.js
```js
const onlyAdminAccess = async(req, res, next) => {
    try{
        //check roles - Not equal to admin ie 1
        if(req.user.role != 1){
            return res.send(400).json({
                success:false,
                message:'You have not permission to access this route!'
            })
        }

    }catch(){

    }
}
```